
<!DOCTYPE html>
<html lang="en">
<head>

    <!--meta tags-->
    <meta charset="UTF-8">
    <meta name="description" content="Services Listing HTML5 CSS3 template">
    <meta name="keywords" content="HTML,CSS,XML,JavaScript, services, listing">
    <meta name="author" content="Ui-DesignLab">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!--end meta tags-->

    <title>OldsMarket Cart</title>
    <!--stylesheets-->
    <link rel="stylesheet" href="vendor/css/bootstrap.min.css">
    <link rel="stylesheet" href="vendor/css/animate.min.css">
    <link rel="stylesheet" href="vendor/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="vendor/perfect-scrollbar/css/perfect-scrollbar.min.css">
    <link rel="stylesheet" href="css/app.css">
    <!--end stylesheets-->

    <!--google fonts-->
    <link href="https://fonts.googleapis.com/css?family=Cairo%7CNosifer%7CPoppins%7CQuicksand:700%7CRaleway%7CTangerine%7CHind+Vadodara" rel="stylesheet">
    <!--end google fonts-->

    <style>
        img{
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
     


<!--navigation bars-->

<div class="sit-bg">
    <nav class="site-top-nav transparent">
        <div class="logo">
            <a href="index.html">
                <img src="img/logo.png" alt="">
                <strong>SchoolOldsMarket</strong>
            </a>
        </div>
        <ul class="site-menu">
            <li>
                <a href="index.html">主页 </a>
            </li>
            <li>
                <a href="#">商品搜索 <i class="fa fa-angle-down"></i></a>
                <ul class="nav-dropdown">
                    <li><a href="items.html">商品列表</a></li>
                    <li><a href="search-results.html">商品搜索</a></li>
                </ul>
            </li>
            <li><a href="#">控制面板 <i class="fa fa-angle-down"></i></a>
                <ul class="nav-dropdown">
                    <li><a href="dash-profile.html">个人信息</a></li>
                    <li><a href="dash-items.html">商品列表</a></li>
                    <li><a href="dash-sales.html">交易记录</a></li>
                </ul>
            </li>
            <li>
                <a href="cart.html">购物车</a>
            </li>
            <li>
                <!--<a href="login-register.html" class="ui-btn ui-btn-info">登陆 / 注册</a>-->
                <div class="site-user">
                    <div class="site-user-img">
                        <img src="img/avatar2.jpg" alt="">
                        <span class="online"></span>
                    </div>
                    <a href="dash-profile.html" class="user-name"><strong>Emma Viola</strong></a>
                </div>
            </li>
        </ul>
        <i class="nav-toggle fa fa-bars"></i>
    </nav>
</div>
<div id="side-nav" class="side-nav">
    <div class="side-nav-menu perfect-scroll">
        <div class="text-logo">
            <a href="index.html"><h3>SOM平台</h3></a>
        </div>
        <div class="site-user">
            <div class="site-user-img">
                <img src="img/avatar2.jpg" alt="">
                <span class="online"></span>
            </div>
            <a href="#" class="user-name"><strong>Emma Viola</strong></a>
        </div>
        <ul class="menu">
            <li><a href="index.html" class="current">首页</a></li>
            <li><a href="items.html">商品列表</a></li>
        </ul>
        <div class="logout"><a href="login-register.html">退出登陆</a></div>
    </div>
</div>
<!--end navigation bars-->

<!--cart section-->
<div class="cart-wrapper">
    <div class="cart">
        <div class="items-count">在你的购物车中已有 <strong class="ui-text-success">0</strong> 件商品</div>
        <table class="table table-responsive cart-table">
            <thead>
                <tr>
                    <th><span class="ui-text-success"><center>商品图片</center></span></th>
                    <th><span class="ui-text-success">商品名称</span></th>
                    <th><span class="ui-text-success">单价</span>/<span class="ui-text-success">数量</span></th>
                    <th><span class="ui-text-success">总价</span></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <div>
                            <i class="fa fa-times-circle remove-item ui-text-danger"></i>
                            <div class="item-img"><img src="img/items/l-item2.png" alt=""></div>
                        </div>
                    </td>
                    <td>
                        <strong>Item name goes here</strong>
                    </td>
                    <td>
                        <div class="price-control">
                            <strong class="unit-price">$ <span data-price="72">72.00</span></strong>
                            <span>x</span>
                            <div class="quantity-change">
                                <span class="minus-item"><i class="fa fa-minus"></i></span>
                                <input class="quantity-input" title="" type="text" value="3">
                                <span class="add-item"><i class="fa fa-plus"></i></span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>$<span class="total">0</span></strong>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div>
                            <i class="fa fa-times-circle remove-item ui-text-danger"></i>
                            <div class="item-img"><img src="img/items/l-item3.png" alt=""></div>
                        </div>
                    </td>
                    <td>
                        <strong>Item name goes here</strong>
                    </td>
                    <td>
                        <div class="price-control">
                            <strong class="unit-price">$ <span data-price="72">72.00</span></strong>
                            <span>x</span>
                            <div class="quantity-change">
                                <span class="minus-item"><i class="fa fa-minus"></i></span>
                                <input class="quantity-input" title="" type="text" value="3">
                                <span class="add-item"><i class="fa fa-plus"></i></span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>$<span class="total">216</span></strong>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div>
                            <i class="fa fa-times-circle remove-item ui-text-danger"></i>
                            <div class="item-img"><img src="img/items/l-item4.png" alt=""></div>
                        </div>
                    </td>
                    <td>
                        <strong>Item name goes here</strong>
                    </td>
                    <td>
                        <div class="price-control">
                            <strong class="unit-price">$ <span data-price="72">72.00</span></strong>
                            <span>x</span>
                            <div class="quantity-change">
                                <span class="minus-item"><i class="fa fa-minus"></i></span>
                                <input class="quantity-input" title="" type="text" value="3">
                                <span class="add-item"><i class="fa fa-plus"></i></span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>$<span class="total">216</span></strong>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div>
                            <i class="fa fa-times-circle remove-item ui-text-danger"></i>
                            <div class="item-img"><img src="img/items/l-item3.png" alt=""></div>
                        </div>
                    </td>
                    <td>
                        <strong>Item name goes here</strong>
                    </td>
                    <td>
                        <div class="price-control">
                            <strong class="unit-price">$ <span data-price="72">72.00</span></strong>
                            <span>x</span>
                            <div class="quantity-change">
                                <span class="minus-item"><i class="fa fa-minus"></i></span>
                                <input class="quantity-input" title="" type="text" value="3">
                                <span class="add-item"><i class="fa fa-plus"></i></span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>$<span class="total">216</span></strong>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div>
                            <i class="fa fa-times-circle remove-item ui-text-danger"></i>
                            <div class="item-img"><img src="img/items/l-item4.png" alt=""></div>
                        </div>
                    </td>
                    <td>
                        <strong>Item name goes here</strong>
                    </td>
                    <td>
                        <div class="price-control">
                            <strong class="unit-price">$ <span data-price="72">72.00</span></strong>
                            <span>x</span>
                            <div class="quantity-change">
                                <span class="minus-item"><i class="fa fa-minus"></i></span>
                                <input class="quantity-input" title="" type="text" value="3">
                                <span class="add-item"><i class="fa fa-plus"></i></span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>$<span class="total">216</span></strong>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="cart-bottom">
            <h3><span>共计:</span>$<strong class="sub-total ui-text-success">1080</strong></h3>
            <p class="cart-bt-act">
                <a href="items.html"><i class="fa fa-angle-left"></i> 继续浏览 </a>
                <a class="continue">下订单 <i class="fa fa-paypal"><!--付款信息 <i class="fa fa-angle-right">--></i></a>
            </p>
        </div>
    </div>
</div>
<!--end cart section-->

<!--chat box-->
<!--<a href="#" class="chat-box-btn"><i class="fa fa-comment icon-sw"></i></a>

<div class="chat-box">
    <div class="chat-top">
        <section>
            <h6 class="org-name">OldsMarket</h6>
            <div class="repliers">
                <div class="r-img">
                    <img src="img/avatar2.jpg" alt="">
                    <strong class="name">Megan</strong>
                </div>
                <div class="r-img">
                    <img src="img/user2.jpg" alt="">
                    <strong class="name">Brandon</strong>
                </div>
            </div>
        </section>
    </div>
    <div class="chat-flow" id="chat-flow">
        <p class="outbound">
            Hallo, Anyone there?
        </p>
        <p class="inbound">
            Hi, Vincent here. How may I be of service.
        </p>
    </div>
    <form class="chat-form" action="#">
        <input type="text" class="form-control chat-message" placeholder="Send a Message">
    </form>
</div>-->

<!--end chat box-->

<!--page loader-->
<div class="page-loader">
    <div class="loader"><img src="img/logo.png" alt=""></div>
</div>
<!--end page loader-->

<!--footer section-->
<footer class="footer">
    <div class="footer-item">
        <strong>取得联系</strong>
        <a href="#"><i class="fa fa-angle-right"></i> 支持</a>
        <a href="#"><i class="fa fa-angle-right"></i> 通知</a>
        <a href="#"><i class="fa fa-angle-right"></i> 社区论坛</a>
        <a href="#"><i class="fa fa-angle-right"></i> 联盟伙伴</a>
        <a href="#"><i class="fa fa-angle-right"></i> 联系我们</a>
    </div>
    <div class="footer-item">
        <strong>疑问?</strong>
        <a href="#"><i class="fa fa-angle-right"></i> 帮助</a>
        <a href="#"><i class="fa fa-angle-right"></i> 联系</a>
        <a href="#"><i class="fa fa-angle-right"></i> 在线客服</a>
    </div>
    <div class="footer-item">
        <strong>相关网站</strong>
        <a href="#"><i class="fa fa-angle-right"></i> 脸谱网</a>
        <a href="#"><i class="fa fa-angle-right"></i> 微博</a>
        <a href="#"><i class="fa fa-angle-right"></i> 网络相册</a>
        <a href="#"><i class="fa fa-angle-right"></i> 视频网站</a>
        <a href="#"><i class="fa fa-angle-right"></i> 人际关系网</a>
    </div>
    <div class="footer-item">
        <strong>资源连接</strong>
        <a href="#"><i class="fa fa-angle-right"></i> 首页</a>
        <a href="#"><i class="fa fa-angle-right"></i> 产品</a>
        <a href="#"><i class="fa fa-angle-right"></i> 服务</a>
        <a href="#"><i class="fa fa-angle-right"></i> 关于我们</a>
    </div>
</footer>
<div class="bottom-strip">
    <div class="cards-accepted">
        <em>Cards Accepted:</em>
        <img src="img/card-logos.png" alt="">
    </div>
    <div class="copyright"><i class="fa fa-copyright"></i> <span>SchoolOldsMarket. 拥有相关所有权</span></div>
    <div class="country"><!--<span>C.N</span><img src="img/USAFlag.png" alt="">--></div>
</div>
<!--end footer section-->

<!--scripts-->
<script src="vendor/js/jquery-3.2.1.min.js"></script>
<script src="vendor/js/popper.js"></script>
<script src="vendor/js/bootstrap.min.js"></script>
<script src="vendor/js/alertify.js"></script>
<script src="vendor/js/jquery.knob.min.js"></script>
<!--[if IE]><script type="text/javascript" src="vendor/js/excanvas.js"></script><![endif]-->
<script src="vendor/js/summernote-bs4.min.js"></script>
<script src="vendor/js/dropzone.js"></script>
<script src="vendor/OwlCarousel2-2.2.1/owl.carousel.min.js"></script>
<script src="vendor/perfect-scrollbar/js/perfect-scrollbar.jquery.min.js"></script>
<script src="js/jquery.cookie.js"></script>
<script src="vendor/js/typed.js"></script>
<script src="js/app.js"></script>
<!--end scripts-->
<script>
    /**
     * 计算总价
     */
    function total() {
        var totalPrice = 0;

        $.each($('.total'), function (index, value) {
            totalPrice += parseFloat(value.textContent);
        });
        return totalPrice
    }

    /**
     * 购物车列表
     */
    var cartGoods = $.cookie("cart");
    console.log(cartGoods);
    if(cartGoods != null && cartGoods != "[]" && cartGoods != "null" ){

        var cartData = JSON.parse(cartGoods);
        var cartTable = $(".cart-table");
        cartTable.find("tbody").empty();
        console.log(cartData);
        var html = "";
        for(var i = 0;i<cartData.length;i++){
            html += "<tr number='"+cartData[i].goodsNumber+"'>\n" +
                "                    <td>\n" +
                "                        <div>\n" +
                "                            <i class='fa fa-times-circle remove-item ui-text-danger'></i>\n" +
                "                            <div class='item-img'><center><img src='img/items/"+cartData[i].goodsImage+"' alt=''></center></div>\n" +
                "                        </div>\n" +
                "                    </td>\n" +
                "                    <td>\n" +
                "                        <strong class='goodsName'>"+cartData[i].goodsName+"</strong>\n" +
                "                    </td>\n" +
                "                    <td>\n" +
                "                        <div class='price-control'>\n" +
                "                            <strong class='unit-price'>$ <span data-price='"+cartData[i].goodsPrice+"'>"+cartData[i].goodsPrice+"</span></strong>\n" +
                "                            <span>x</span>\n" +
                "                            <div class='quantity-change'>\n" +
                "                                <span class='minus-item'><i class='fa fa-minus'></i></span>\n" +
                "                                <input class='quantity-input' title='' type='text' value='"+cartData[i].bayNumber+"'>\n" +
                "                                <span class='add-item'><i class='fa fa-plus'></i></span>\n" +
                "                            </div>\n" +
                "                        </div>\n" +
                "                    </td>\n" +
                "                    <td>\n" +
                "                        <strong>$<span class='total'>" +
                cartData[i].goodsPrice * cartData[i].bayNumber +
                "</span></strong>\n" +
                "                    </td>\n" +
                "                </tr>"
        }
        cartTable.find("tbody").append(html);
        //总金额
        $('.sub-total').text(total());
        //商品样数
        $(".items-count .ui-text-success ").text(cartData.length);

        /**
         * 删除购物车的商品
         */
        $('.remove-item').on('click', function () {
            var indexName = $(this).parent().parent().parent().find(".goodsName").text();
            console.log(indexName);
            for(var i=0;cartData.length;i++){
                if(indexName == cartData[i].goodsName){
                    cartData.splice(i,1);
                    $.cookie("cart",JSON.stringify(cartData));
                    alertify.success("已删除");
                    break;
                }
            }
            if(cartData.length == 0){
                cartTable.find("tbody").empty();
                cartTable.find("tbody").append("<tr><td style='color: red' colspan='4'><center>您的购物车没有商品！</center></td></tr>");
                $(".sub-total").text(0);
                console.log("购物车已经没有商品了。");
            }
            $(this).closest('tr').fadeOut().remove();
            $('.sub-total').text(total());
        });
    }else{
        var cartTable = $(".cart-table");
        cartTable.find("tbody").empty();
        var html = "<tr><td style='color: red' colspan='4'><center>您的购物车没有商品！</center></td></tr>"
        cartTable.find("tbody").append(html);
        $(".sub-total").text(0);
    }

    /**
     * 登陆人的用户信息显示
     * @type {string | null}
     */
    var checkLogin = sessionStorage.getItem("userInfo");
    if(checkLogin == null){
        console.log("login信息为空");
        $(".site-top-nav .site-menu > li:last-child").empty();
        $(".start-here").empty();
        var html = "";
        var loginHtml = "";
        html += "<a href='login-register.html' class='ui-btn ui-btn-info'>登陆 / 注册</a>";
        loginHtml +="<div id='notLogin'>\n" +
            "        <h3>在这儿登陆</h3>\n" +
            "        <p>\n" +
            "            您未登录，无法进行下单等操作，请登陆尽快！\n" +
            "        </p>\n" +
            "        <div class='divide'>\n" +
            "            <a href='login-register.html' class='ui-btn ui-btn-info'>登陆</a>\n" +
            "            <strong class='ui-text-success'>Or</strong>\n" +
            "            <a href='login-register.html' class='ui-btn ui-btn-prim'>注册</a>\n" +
            "        </div>\n" +
            "\n" +
            "    </div>";

        $(".site-top-nav .site-menu > li:last-child").append(html);
        $(".start-here").append(loginHtml);

    }else{
        console.log(checkLogin);
        var userInfo = JSON.parse(checkLogin);
        $(".site-top-nav .site-menu > li:last-child").empty();
        $(".start-here").empty();
        var html = "";
        var loginHtml = "";
        html += "<div class='site-user'>\n" +
            "                    <div class='site-user-img'>\n" +
            "                        <img src='img/userimg/"+userInfo.headPortrait+"' alt=''>\n" +
            "                        <span class='online'></span>\n" +
            "                    </div>\n" +
            "                    <a href='dash-profile.html' class='user-name'><strong>"+userInfo.userName+"</strong></a>\n" +
            "                </div>";

        loginHtml += "<div id='logined'>\n" +
            "        <h3>已登陆</h3>\n" +
            "        <p>\n" +
            "            您的账号已经登录，可以进行下单等操作，祝您购物愉快！\n" +
            "        </p>\n" +
            "    </div>";
        $(".site-top-nav .site-menu > li:last-child").append(html);
        $(".start-here").append(loginHtml);
    }

    /**
     * 下单按钮
     */
    $(".continue").click(function () {
        //购物车列表
        var cartList = [];
        //下单列表
        var orderList=[];
        //cookie删除列表
        var deleletList=[];

        var userInfo = JSON.parse(checkLogin);
        if("" == userInfo.identity || undefined == userInfo.identity || null == userInfo.identity){
            alertify.error("个人信息未完善，无法进行商品下单！请完善个人信息！");
        }else{
            alertify.confirm("确定要下单吗？购买数量为0的商品不能下单！",function () {
                $("tr").each(function (index,ele) {
                    //排除表头tr，从1开始获取
                    if(0 != index ){
                        var goodsNumber = $(ele).attr("number");
                        var goodsName = $(ele).find(".goodsName").text();
                        var goodsImage = $(ele).find("img").attr("src");
                        goodsImage = goodsImage.substring(goodsImage.lastIndexOf("/")+1);
                        var price = $(ele).find(".unit-price").find("span").text();
                        var bayNumber = $(ele).find(".quantity-input").val();
                        var total = $(ele).find(".total").text();
                        /**
                         * 单条购物车商品
                         */
                        var itemCart = {
                            goodsNumber:goodsNumber,
                            goodsImage:goodsImage,
                            goodsName:goodsName,
                            goodsPrice:price,
                            bayNumber:bayNumber
                        };
                        /**
                         * 单个订单信息
                         * @type {{goodsNumber: *|jQuery, bayNumber: *|jQuery}}
                         */
                        var order = {
                            goodsNumber:goodsNumber,
                            bayNumber : bayNumber,
                            buyerId:userInfo.id
                        };

                        /**
                         * 判断是否有购买数量，大于0，下订单，删购物车，小于0，不下订单
                         */
                        if(bayNumber>0){
                            orderList.push(order);
                            deleletList.push(index);
                        }else{
                            cartList.push(itemCart);
                        }
                    }
                });
                console.log(cartList);
                console.log(orderList);
                /**
                 * 下单Ajax
                 **/
                var orderAjax = function () {
                    $.ajax({
                        url:"http://localhost:8080/ctp/order/0/batch",
                        type:"post",
                        dataType:"json",
                        data:JSON.stringify(orderList),
                        contentType:"application/json",
                        success:function (result) {
                            console.log(result);
                            if(result.success){
                                alertify.success("下单成功！");
                                console.log(deleletList);
                                $("tr").each(function (index,ele) {
                                    if(index > 0){
                                        for(var i = 0;i<deleletList.length;i++){
                                            if(index == deleletList[i]){
                                                $(ele).find(".remove-item").click();
                                            }
                                        }
                                    }
                                });
                                $.cookie("cart",JSON.stringify(cartList));
                                //window.location.href = "order-success.html";
                            }else{
                                alertify.error(result.message);
                            }

                        },error:function () {
                            console.log("下单请求失败！");
                        }
                    });
                };
                orderAjax();

            },function () {
                alertify.error("已取消下单操作");
            });
        }

        // window.location.href = "payment-info.html";
    });

</script>
</body>
</html>
